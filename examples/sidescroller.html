<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Dolly side scroller test</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	</head>
	<body>
		<script type="text/javascript" src="//povdocs.github.io/webvr-starter-kit/build/vr.dev.js"></script>
		<script type="text/javascript" src="../build/index.js" charset="utf-8"></script>
		<script type="text/javascript">
		var SPEED = 10;
		var PLAYER_HEIGHT = 1;
		var halfPlayer = PLAYER_HEIGHT / 2;

		var moveLeft = false;
		var moveRight = false;
		var canJump = true;

		function keyDown(evt) {
			switch (event.keyCode) {
				case 37: //left
				case 65: //a
					moveLeft = true;
					break;
				case 39: //right
				case 68: //d
					moveRight = true;
					break;
				case 32: //space
				case 38: //update
				case 87: //w
					if (canJump) {
						velocity.y += 8;
						canJump = false;
					}
					break;
			}
		}

		function keyUp(evt) {
			switch (event.keyCode) {
				case 37: //left
				case 65: //a
					moveLeft = false;
					break;
				case 39: //right
				case 68: //d
					moveRight = false;
					break;
			}
		}
		document.addEventListener('keydown', keyDown, false);
		document.addEventListener('keyup', keyUp, false);

		VR.floor();
		VR.camera.object.fov = 30;
		VR.camera.object.updateProjectionMatrix();
		var dolly = new Dolly();

		//player
		var velocity = new THREE.Vector3();
		var player = VR.box({ color: 'darkblue' })
			.setScale(0.5, PLAYER_HEIGHT, 0.5)
			.moveUp(halfPlayer);
		var playerProp = dolly.prop({
			name: 'player'
		}).on('updatestart', function (position) {
			position.copy(player.position);
		});

		var lookAhead = dolly.prop().on('updatestart', function (position) {
			position.copy(player.position);
			position.x += velocity.x * 1.5;
			position.y += velocity.y * 0.1;
		});

		//camera
		VR.body.position.set(0, 1, 20).add(player.position);
		var camProp = dolly.prop({
			name: 'camera',
			position: VR.body.position,
			lag: 0.8
		});
		camProp.follow(playerProp, {
			offset: [0, 1, 20],
			weight: [0, 1, 0],
			radius: 2
		});
		camProp.follow(lookAhead, {
			offset: [0, 1, 20],
			radius: 2
		});
		camProp.on('updated', function (position) {
			VR.body.position.copy(position);
		});

		//castle
		var castle = VR.empty().moveX(40).moveZ(-4);
		castle.box({ material: 'stone' }).setScale(12.5, 6, 1).moveUp(3);
		castle.cylinder({ material: 'stone' }).setScale(6, 20, 6).moveUp(3).moveX(-9);
		castle.cylinder({ material: 'stone' }).setScale(6, 20, 6).moveUp(3).moveX(9);
		var castleScene = dolly.prop({
			position: castle.position
		});
		camProp.attract(playerProp, castleScene, {
			offset: [0, 6, 40],
			innerRadius: 10,
			outerRadius: 14
		});

		var castleTitle = castle.text('Welcome to the castle!').moveUp(30).setScale(3);
		castleTitle.visible = false;
		playerProp.on('enterattractor', function (prop, att) {
			console.log('approaching castle');
			castleTitle.visible = true;
			castleTitle.position.y = 20 - 10 * att;
		});
		playerProp.on('moveattractor', function (prop, att) {
			castleTitle.position.y = 20 - 10 * att;
		});
		playerProp.on('leaveattractor', function () {
			castleTitle.visible = false;
			console.log('left castle');
		});

		//edge of the world
		var edgeRight = dolly.prop({
			position: [100, halfPlayer, 0]
		});
		camProp.attract(playerProp, edgeRight, {
			offset: [2, halfPlayer / 2, 10],
			innerRadius: 2,
			outerRadius: 12
		});

		VR.animate(function (delta) {
			//decelerate player
			velocity.x -= velocity.x * 2 * delta;
			velocity.y -= 9.8 * 1 * delta; // 0.1 = mass

			if (moveLeft) {
				velocity.x -= SPEED * delta;
			}
			if (moveRight) {
				velocity.x += SPEED * delta;
			}

			//todo: land on platform?

			player.moveX(velocity.x * delta);
			player.moveY(velocity.y * delta);
			player.position.x = Math.min(100, Math.max(-100, player.position.x));

			//collisions with floor and stuff
			if (player.position.y < halfPlayer) {
				player.position.y = halfPlayer;
				velocity.y = 0;
				canJump = true;
			}

			dolly.update(delta);
		});
		</script>
	</body>
</html>